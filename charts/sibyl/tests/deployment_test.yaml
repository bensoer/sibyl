suite: deployment
templates:
  - deployment.yaml
tests:
  - it: should create a deployment by default
    set:
      image:
        tag: "0.0.1"
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: RELEASE-NAME-sibyl
      - equal:
          path: spec.replicas
          value: 1
      - equal:
          path: spec.template.spec.containers[0].image
          value: "ghcr.io/bensoer/sibyl:0.0.1"
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: IfNotPresent

  - it: should set image tag and pull policy
    set:
      image:
        tag: "my-tag"
        pullPolicy: Always
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: "ghcr.io/bensoer/sibyl:my-tag"
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: Always

  - it: should set replica count
    set:
      replicaCount: 3
    asserts:
      - equal:
          path: spec.replicas
          value: 3

  - it: should set resources
    set:
      resources:
        limits:
          cpu: 200m
          memory: 256Mi
        requests:
          cpu: 100m
          memory: 128Mi
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: 200m
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: 100m

  - it: should set security context
    set:
      securityContext:
        runAsUser: 1001
      podSecurityContext:
        fsGroup: 2001
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsUser
          value: 1001
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 2001

  - it: should have correct probes by default
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: /health
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.port
          value: 8080
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: /ready
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.port
          value: 8080

  - it: should allow overriding probes
    set:
      livenessProbe:
        httpGet:
          path: /live
          port: 8081
      readinessProbe:
        httpGet:
          path: /readyz
          port: 8082
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: /live
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.port
          value: 8081
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: /readyz
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.port
          value: 8082
